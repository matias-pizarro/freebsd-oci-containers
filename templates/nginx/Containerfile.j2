#
# NOTE: THIS DOCKERFILE IS GENERATED VIA "update.sh"
#
# PLEASE DO NOT EDIT IT DIRECTLY.
#
FROM {% if registry.name %}{{ registry.name }}/{% endif %}{% if registry.username %}{{ registry.username }}/{% endif %}{% if registry.project %}{{ registry.project }}/{% endif %}freebsd-zfs:{{ os_major_version }}.{{ short_os_minor_version }}

LABEL maintainer="Mat√≠as Pizarro <docker@docbase.net>"

# create nginx user/group first, to be consistent throughout docker variants
RUN echo "nginx:101:::0:0:nginx user:/nonexistent:/usr/bin/false:" | adduser -D -S -f -

ENV NGINX_VERSION   {{ extra[project_version]["nginx_version"] }}
ENV NJS_VERSION     {{ extra[project_version]["njs_version"] }}

# should provide modules xslt geoip image njs
RUN set -eux; \
    /usr/bin/env pkg install -yr FreeBSD-ports \
        www/nginx-{{ extra[project_version]["pkg_version"] }} \
    && rm -f /var/cache/pkg/* \
    && rm -rf /var/db/pkg/* \
    \
# forward request and error logs to docker log collector
    && ln -sf /dev/stdout /var/log/nginx/access.log \
    && ln -sf /dev/stderr /var/log/nginx/error.log \
# create a docker-entrypoint.d directory
    && mkdir /docker-entrypoint.d

COPY docker-entrypoint.sh /
COPY 10-listen-on-ipv6-by-default.sh /docker-entrypoint.d
COPY 15-local-resolvers.envsh /docker-entrypoint.d
COPY 20-envsubst-on-templates.sh /docker-entrypoint.d
COPY 30-tune-worker-processes.sh /docker-entrypoint.d
ENTRYPOINT ["/docker-entrypoint.sh"]

COPY --chown=0:0 --chmod=0644 nginx.conf /usr/local/etc/nginx/nginx.conf
COPY --chown=0:0 --chmod=0644 default.conf /usr/local/etc/nginx/conf.d/default.conf

RUN /usr/local/sbin/nginx -t

EXPOSE 80

STOPSIGNAL SIGQUIT

CMD ["/usr/local/sbin/nginx", "-g", "daemon off;"]
